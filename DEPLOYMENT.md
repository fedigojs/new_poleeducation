# Руководство по деплою

## Применение миграций на проде

### 1. Применить новую миграцию
```bash
make migrate-prod
```

### 2. Откатить последнюю миграцию (если что-то пошло не так)
```bash
make migrate-undo-prod
```

## Деплой с локальной сборкой фронтенда (рекомендуется для серверов с 2GB RAM)

### Вариант 1: Полный деплой (backend + frontend)
```bash
# Устанавливаем переменную REMOTE_SERVER в Makefile
# REMOTE_SERVER = user@your-server.com

make deploy-with-local-build
```

Эта команда:
1. Остановит контейнеры на проде
2. Запустит backend и базу данных
3. Применит миграции
4. Соберет фронтенд **локально** (на вашем компьютере)
5. Загрузит собранный фронтенд на сервер через rsync
6. Перезагрузит nginx

### Вариант 2: Только фронтенд
```bash
# Сначала соберите локально
make build-frontend-local

# Затем задеплойте
make deploy-frontend-local
```

### Вариант 3: Только применить миграцию (без деплоя)
```bash
make migrate-prod
```

## Почему локальная сборка?

**Проблема:** React (Create React App) требует ~2GB RAM для сборки
**Решение:** Собираем локально, загружаем только готовый build

### Преимущества:
- ✅ Экономия RAM на сервере
- ✅ Быстрее (нет сборки на медленном сервере)
- ✅ Надежнее (если сборка упала, сервер продолжает работать)

## Миграция на Vite (рекомендуется для будущего)

### Зачем переходить на Vite?

| Параметр | Create React App | Vite |
|----------|------------------|------|
| Время сборки dev | 30-60 сек | 1-3 сек |
| Время сборки prod | 2-5 мин | 30-60 сек |
| Hot reload | Медленный | Мгновенный |
| RAM для сборки | ~2GB | ~500MB |
| Поддержка | Deprecated | Активная |

### Create React App больше не поддерживается!
React команда рекомендует мигрировать на Vite или Next.js

### План миграции на Vite (когда будет время):

```bash
# 1. Установить Vite
npm install -D vite @vitejs/plugin-react

# 2. Создать vite.config.js
# 3. Обновить index.html (вынести в корень)
# 4. Изменить package.json scripts
# 5. Тестировать
```

Примерное время: 1-2 часа работы + тестирование

## Текущая настройка для прода

### Если на сервере мало RAM:
1. **Используйте локальную сборку** (команды выше)
2. Можно увеличить swap на сервере:
```bash
# На сервере
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### Автоматический деплой (CI/CD - будущее улучшение)
Можно настроить GitHub Actions для автоматической сборки и деплоя при push в main ветку.

## Быстрая справка

```bash
# Миграция на проде
make migrate-prod

# Откат миграции
make migrate-undo-prod

# Сборка фронтенда локально
make build-frontend-local

# Деплой фронтенда
make deploy-frontend-local

# Полный деплой
make deploy-with-local-build

# Бэкап базы перед миграцией
make backup-db
```

## Чеклист перед деплоем миграций

- [ ] Создать бэкап базы данных: `make backup-db`
- [ ] Убедиться что миграция работает локально
- [ ] Проверить что нет конфликтов в модели
- [ ] Применить миграцию: `make migrate-prod`
- [ ] Проверить логи: `docker logs poleeducation_backend`
- [ ] Проверить что приложение работает
- [ ] Если что-то не так: `make migrate-undo-prod`
