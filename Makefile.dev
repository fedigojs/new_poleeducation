# Переменные
DOCKER_COMPOSE = docker-compose -f docker-compose.dev.yml
BACKUP_DIR = /var/www/poleeducation/backup
VOLUME_NAME = poleeducation_db_data
REMOTE_SERVER = user@your-server.com
LOCAL_BACKUP_PATH = ./poleeducation_db_backup.tar.gz
DOMAIN = poleeducation.in.ua
EMAIL = fedigo.sj@gmail.com

# Основная команда для деплоя
build-and-deploy:
	@echo "Деплой проекта..."
	$(DOCKER_COMPOSE) down --remove-orphans || { echo "Failed to stop containers"; exit 1; }
	docker system prune -af || { echo "Failed to prune Docker caches"; exit 1; }
	sudo rm -rf /var/www/html/* || { echo "Failed to clear /var/www/html"; exit 1; }
	sudo systemctl reload nginx || { echo "Failed to reload Nginx"; exit 1; }
	$(DOCKER_COMPOSE) up -d db_auth backend || { echo "Failed to start backend containers"; exit 1; }
	$(DOCKER_COMPOSE) run --rm frontend-builder sh -c "rm -rf /frontend/build/*" || { echo "Failed to clear old frontend build"; exit 1; }
	$(DOCKER_COMPOSE) run --rm frontend-builder sh -c "pnpm install && pnpm run build" || { echo "Frontend build failed"; exit 1; }
	docker run --rm -v poleeducation_build:/frontend/build -v /var/www/html:/nginx-html alpine sh -c "cp -r /frontend/build/* /nginx-html" || { echo "Failed to copy frontend build to Nginx directory"; exit 1; }
	$(DOCKER_COMPOSE) rm -f frontend-builder || { echo "Failed to remove frontend-builder container"; exit 1; }
	sudo systemctl reload nginx || { echo "Failed to reload Nginx after deployment"; exit 1; }
	@echo "Деплой завершён."

# SSL Certificate Generation and Installation
generate-ssl:
	@echo "Generating SSL certificate for $(DOMAIN)..."
	sudo apt update && sudo apt install -y certbot python3-certbot-nginx || { echo "Failed to install Certbot"; exit 1; }
	sudo certbot --nginx -d $(DOMAIN) --email $(EMAIL) --agree-tos --non-interactive || { echo "Failed to generate SSL certificate"; exit 1; }
	sudo systemctl reload nginx || { echo "Failed to reload Nginx"; exit 1; }
	@echo "SSL certificate installed successfully!"

# Auto-renew SSL Certificate
renew-ssl:
	@echo "Renewing SSL certificate..."
	sudo certbot renew --quiet || { echo "Failed to renew SSL certificate"; exit 1; }
	sudo systemctl reload nginx || { echo "Failed to reload Nginx"; exit 1; }
	@echo "SSL certificate renewed successfully."

# Бэкап базы данных
backup-db:
	@echo "Создание бэкапа базы данных..."
	docker run --rm \
	  -v $(VOLUME_NAME):/data \
	  -v $(BACKUP_DIR):/backup \
	  busybox tar czf /backup/poleeducation_db_backup.tar.gz -C /data . || { echo "Failed to create database backup"; exit 1; }
	@echo "Бэкап базы данных создан в $(BACKUP_DIR)/poleeducation_db_backup.tar.gz"

# Восстановление базы данных из бэкапа
restore-db:
	@echo "Восстановление базы данных из бэкапа..."
	docker stop poleeducation_db || { echo "Failed to stop database container"; exit 1; }
	docker run --rm \
	  -v $(VOLUME_NAME):/var/lib/postgresql/data \
	  -v $(BACKUP_DIR):/backup \
	  busybox tar xzf /backup/poleeducation_db_backup.tar.gz -C /var/lib/postgresql/data || { echo "Failed to restore database from backup"; exit 1; }
	docker start poleeducation_db || { echo "Failed to start database container"; exit 1; }
	docker logs poleeducation_db || { echo "Failed to retrieve database logs"; exit 1; }
	@echo "Восстановление базы данных завершено."

# Очистка папки бэкапов
clean-backups:
	@echo "Очистка старых бэкапов..."
	sudo rm -rf $(BACKUP_DIR)/* || { echo "Failed to clean backup directory"; exit 1; }
	@echo "Папка бэкапов очищена."

# Просмотр последних логов базы данных
db-logs:
	docker logs poleeducation_db || { echo "Failed to retrieve database logs"; exit 1; }

# Скачивание последнего бэкапа с сервера
download-backup:
	@echo "Скачивание последнего бэкапа с сервера..."
	scp $(REMOTE_SERVER):$(BACKUP_DIR)/poleeducation_db_backup.tar.gz $(LOCAL_BACKUP_PATH) || { echo "Failed to download backup"; exit 1; }
	@echo "Последний бэкап скачан в $(LOCAL_BACKUP_PATH)"
